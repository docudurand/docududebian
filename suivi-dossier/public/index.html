<!DOCTYPE html>
<!--page suivi dossier atelier-->
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suivi des dossiers Atelier</title>
<style>
  :root{
    --primary:#004080; --line:#e5e7eb; --ink:#0f172a;
    --s1:#2563eb10; --s2:#16a34a10; --s3:#f59e0b10; --s4:#9333ea10;
    --s1b:#2563eb;   --s2b:#16a34a;   --s3b:#d97706;   --s4b:#7e22ce;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--ink)}
  .wrap{max-width:1680px;margin:22px auto;padding:14px}
  h1{ margin:0 0 10px; font-size:1.35rem; color:var(--primary); }

  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:6px 0 12px}
  label{font-weight:600;color:#334155}
  select,input{padding:8px 10px; border:1px solid var(--line); border-radius:10px; font-size:.95rem; background:#fff}

  .yearbar{margin:10px 0 12px;display:flex;flex-direction:column;gap:8px}
  .yearTabs{display:flex;gap:8px;flex-wrap:wrap}
  .yearBtn{background:#fff;color:#073763;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-weight:700;cursor:pointer;font-size:.95rem}
  .yearBtn.active{background:#004080;color:#fff;border-color:#004080}
  .months{display:none;gap:6px;flex-wrap:wrap}
  .months.active{display:flex}
  .monthBtn{background:#fff;border:1px solid var(--line);color:#073763;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:600;font-size:.9rem}
  .monthBtn.active{background:#eef5ff;border-color:#bcd7ff}

  .statusTabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:4px;
    margin-bottom:4px;
  }
  .statusBtn{
    background:#fff;
    border:1px solid var(--line);
    color:#073763;
    border-radius:999px;
    padding:5px 10px;
    cursor:pointer;
    font-weight:600;
    font-size:.85rem;
  }
  .statusBtn.active{
    background:#004080;
    color:#fff;
    border-color:#004080;
  }

  .legend{opacity:.8;font-size:.9rem}

  .tableWrap{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
  table{width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:fixed; background:#fff}
  thead th{
    background:#f8fbff; text-align:left; padding:10px 12px; color:#334155; font-size:.92rem; border-bottom:1px solid var(--line);
    white-space:nowrap;
  }
  thead th.th-eta, thead th.th-actions{ white-space:normal; line-height:1.15; }
  tbody tr{background:#fff}
  tbody td{padding:10px 12px; font-size:.95rem; vertical-align:middle; border:0; background:#fff}

  .col-no        { width: 4%  }
  .col-magasin   { width: 10% }
  .col-compte    { width: 8%  }
  .col-client    { width: 13% }
  .col-service   { width: 14% }
  .col-date      { width: 9%  }
  .col-statut    { width: 11% }
  .col-eta       { width: 15% }
  .col-actions   { width: 12% }

  .nowrap   { white-space:nowrap; }
  .truncate { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .wrap-ok  { white-space:normal; word-break:break-word; }

  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:5px 8px;
    border-radius:999px;
    font-weight:700;
    font-size:.84rem;
    min-width:84px;
    max-width:130px;
    text-align:center;
    white-space:normal;
    line-height:1.1;
  }

  .btnSave{ display: inline-flex;  align-items: center;  justify-content: center;}
  .s-1{background:var(--s1); color:var(--s1b)}
  .s-2{background:var(--s2); color:var(--s2b)}
  .s-3{background:var(--s3); color:var(--s3b)}
  .s-4{background:var(--s4); color:var(--s4b)}

  .actions{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:nowrap}
  .statusSel{padding:7px 10px; border:1px solid var(--line); border-radius:10px; font-size:.9rem; min-width:155px;}
  .etaSel{
    padding:6px 8px; border:1px solid var(--line); border-radius:10px; font-size:.9rem;
    width:54px; min-width:54px; text-align:center; appearance:auto;
  }
  .etaSel.readonlyLimited{
    font-weight:700;
    color:#0b4a6f;
    background:#eef5ff;
    border-color:#bcd7ff;
    pointer-events:none;
  }

  button{
    appearance:none; border:1px solid var(--primary); background:#fff; color:#004080;
    padding:7px 10px; border-radius:10px; font-weight:700; cursor:pointer; font-size:.9rem
  }

  .etaGroup{ display:flex; align-items:center; gap:35px; }

  .btnView{
    white-space:normal; line-height:1.05; padding:6px 8px;
    min-width:72px; max-width:84px; text-align:center;
  }

  .spinner{
    width:14px;height:14px;border:2px solid #e5e7eb;border-top-color:#004080;border-radius:50%;
    animation:spin 1s linear infinite;display:inline-block;vertical-align:middle
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .mask{ position:fixed; inset:0; background:#0008; display:none; align-items:flex-start; justify-content:center; z-index:10000; padding:16px; }
  .box{ width:min(900px,96vw); max-height:min(90vh,800px); background:#fff; border-radius:14px; overflow:auto; border:1px solid var(--line); margin-top:10px; }
  .bar{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--line); background:#f8fbff}
  .content{padding:12px}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:6px 14px}
  .label{font-weight:700}
  .section{margin-top:12px}
  .section h3{margin:8px 0; color:#0b4a6f; font-size:.95rem}
  .area{border:1px solid var(--line); padding:10px; white-space:pre-wrap}

  .loginOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding-top:20px;
    z-index:20000;
  }
  .loginBox{
    background:#fff;
    padding:16px 18px;
    border-radius:10px;
    box-shadow:0 4px 18px rgba(0,0,0,0.25);
    min-width:260px;
    max-width:320px;
    font-size:.9rem;
  }
  .loginBox h2{
    margin:0 0 6px;
    font-size:1.05rem;
    color:#004080;
    text-align:center;
  }
  .loginBox p{
    margin:0 0 10px;
    font-size:.88rem;
    color:#4b5563;
    text-align:center;
  }
  .loginBox input{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #d1d5db;
    font-size:.95rem;
    margin-bottom:8px;
  }
  .loginBox button{
    width:100%;
    padding:8px 10px;
    border-radius:999px;
    border:0;
    background:#004080;
    color:#fff;
    font-weight:700;
    font-size:.9rem;
    cursor:pointer;
  }
  .loginBox .error{
    margin-top:6px;
    font-size:.8rem;
    color:#b91c1c;
    text-align:center;
    min-height:1em;
  }
  .rememberLabel{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:.8rem;
    color:#4b5563;
    margin-bottom:6px;
    user-select:none;
  }

  html.dsg-in-iframe, html.dsg-in-iframe body {
    height: auto !important;
    overflow-x: hidden !important;
    overflow-y: auto !important;
  }

  /* Boutons admin */
  .btnEdit {
    appearance:none; border:1px solid #0e7490; background:#ecfeff; color:#0e7490;
    padding:6px 9px; border-radius:10px; font-weight:700; cursor:pointer; font-size:.85rem;
    white-space:nowrap;
  }
  .btnEdit:hover { background:#cffafe; }
  .btnDelete {
    appearance:none; border:1px solid #b91c1c; background:#fef2f2; color:#b91c1c;
    padding:6px 9px; border-radius:10px; font-weight:700; cursor:pointer; font-size:.85rem;
    white-space:nowrap;
  }
  .btnDelete:hover { background:#fee2e2; }

  /* Modale √©dition admin */
  .editMask {
    position:fixed; inset:0; background:#0009; display:none;
    align-items:flex-start; justify-content:center; z-index:30000; padding:16px;
  }
  .editBox {
    width:min(780px,96vw); max-height:min(92vh,860px); background:#fff;
    border-radius:14px; overflow:auto; border:1px solid #e5e7eb; margin-top:10px;
  }
  .editBar {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; border-bottom:1px solid #e5e7eb; background:#f0fdf4;
    position:sticky; top:0; z-index:1;
  }
  .editBar h2 { margin:0; font-size:1rem; color:#065f46; }
  .editContent { padding:16px; }
  .editSection { margin-bottom:18px; }
  .editSection h3 { margin:0 0 10px; color:#0b4a6f; font-size:.93rem; border-bottom:1px solid #e5e7eb; padding-bottom:4px; }
  .editGrid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .editField { display:flex; flex-direction:column; gap:4px; }
  .editField label { font-weight:700; font-size:.82rem; color:#374151; }
  .editField input, .editField select, .editField textarea {
    padding:7px 9px; border:1px solid #d1d5db; border-radius:8px; font-size:.9rem; font-family:inherit;
  }
  .editField textarea { resize:vertical; min-height:80px; }
  .editFooter {
    display:flex; gap:10px; justify-content:flex-end;
    padding:12px 14px; border-top:1px solid #e5e7eb; background:#f9fafb;
    position:sticky; bottom:0;
  }
  .btnEditSave {
    padding:9px 20px; background:#004080; color:#fff; border:0;
    border-radius:10px; font-weight:700; font-size:.92rem; cursor:pointer;
  }
  .btnEditCancel {
    padding:9px 16px; background:#fff; color:#374151; border:1px solid #d1d5db;
    border-radius:10px; font-weight:700; font-size:.92rem; cursor:pointer;
  }
  .adminBadge {
    display:inline-block; background:#fef3c7; color:#92400e; border:1px solid #fcd34d;
    border-radius:999px; padding:2px 10px; font-size:.78rem; font-weight:700;
    margin-left:10px; vertical-align:middle;
  }
</style>
</head>
<body>
<script>
(function () {
  try {
    if (window.self !== window.top) {
      document.documentElement.classList.add("dsg-in-iframe");
    }
  } catch (e) {
    document.documentElement.classList.add("dsg-in-iframe");
  }

  function heightNow() {
    const b = document.body;
    const d = document.documentElement;
    return Math.max(
      d ? d.scrollHeight : 0,
      d ? d.offsetHeight : 0,
      d ? d.clientHeight : 0,
      b ? b.scrollHeight : 0,
      b ? b.offsetHeight : 0,
      b ? b.clientHeight : 0
    );
  }

  function send() {
    parent.postMessage({ type: "dsg-iframe-size", height: heightNow() + 24 }, "*");
  }

  window.addEventListener("load", send, { once: true });

  try {
    const ro = new ResizeObserver(() => send());
    ro.observe(document.documentElement);
  } catch (e) {}

  window.addEventListener("message", (e) => {
    if (e.data && e.data.type === "dsg-iframe-request-size") send();
  });

  let n = 0;
  const it = setInterval(() => {
    send();
    if (++n >= 20) clearInterval(it);
  }, 300);
})();
</script>

<div class="loginOverlay" id="loginOverlay">
  <div class="loginBox">
    <h2>Acc√®s suivi atelier</h2>
    <p>Veuillez saisir votre mot de passe.</p>

    <input
      type="password"
      id="loginPassword"
      placeholder="Mot de passe"
      autocomplete="current-password"
    />
    <label class="rememberLabel">
      <input type="checkbox" id="rememberPwd" checked />
      Se souvenir du mot de passe sur cet appareil
    </label>
    <button type="button" id="loginBtn">Se connecter</button>
    <div class="error" id="loginError"></div>
  </div>
</div>

<div class="wrap">
  <div class="toolbar">
    <label>Filtrer magasin :
      <select id="filterMag">
        <option value="">Tous</option>
        <option>Annemasse</option><option>Bourgoin</option><option>Chasse sur Rhone</option><option>Chassieu</option><option>Gleize</option><option>La Motte Servolex</option><option>Miribel</option>
        <option>Renage</option><option>Rives</option><option>Seynod</option><option>St Egreve</option><option>St-Jean-Bonnefonds</option>
      </select>
    </label>

    <label id="serviceFilterContainer" style="display:none;">
      Filtrer service :
      <select id="filterService">
        <option value="">Tous</option>
      </select>
    </label>

    <input id="q" type="search" placeholder="Rechercher (n¬∞, compte, client)" style="min-width:280px" />
  </div>

  <div class="yearbar" aria-label="Filtre par ann√©e et mois (Date de la demande)">
    <div class="yearTabs" role="tablist" aria-label="Ann√©es">
      <button type="button" class="yearBtn" data-year="2025" role="tab" aria-controls="months-2025" aria-selected="false">2025</button>
      <button type="button" class="yearBtn" data-year="2026" role="tab" aria-controls="months-2026" aria-selected="false">2026</button>
    </div>
    <div id="months-2025" class="months" role="tabpanel" aria-label="Mois 2025"></div>
    <div id="months-2026" class="months" role="tabpanel" aria-label="Mois 2026"></div>

    <div class="statusTabs" id="statusTabs" aria-label="Filtre par statut">
      <button type="button" class="statusBtn active" data-status="">Tout</button>
      <button type="button" class="statusBtn" data-status="Demande envoy√©">Demande envoy√©</button>
      <button type="button" class="statusBtn" data-status="Pi√®ce re√ßu">Pi√®ce re√ßu</button>
      <button type="button" class="statusBtn" data-status="Travaux en cours">Travaux en cours</button>
      <button type="button" class="statusBtn" data-status="Renvoy√©">Pi√®ce Renvoy√©</button>
    </div>

    <div class="legend" id="legend"></div>
  </div>

  <div class="tableWrap">
    <table id="tab">
      <colgroup>
        <col class="col-no">
        <col class="col-magasin">
        <col class="col-compte">
        <col class="col-client">
        <col class="col-service">
        <col class="col-date">
        <col class="col-statut">
        <col class="col-eta">
        <col class="col-actions">
      </colgroup>
      <thead>
        <tr>
          <th class="nowrap">N¬∞</th>
          <th class="wrap-ok">Magasin</th>
          <th class="nowrap">N¬∞ de compte</th>
          <th class="truncate">Client</th>
          <th class="truncate">Service</th>
          <th class="nowrap">Date</th>
          <th class="nowrap">Statut</th>
          <th class="th-eta">Estimation<br>Temps Travaux<br>(Jours)</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody aria-live="polite"></tbody>
    </table>
  </div>
</div>

<div class="mask" id="mask" aria-hidden="true">
  <div class="box" role="dialog" aria-label="Dossier">
    <div class="bar">
      <div id="modalTitle" style="font-weight:800;color:#004080">Dossier</div>
      <div>
        <button id="btnPrint">Imprimer</button>
        <button id="btnClose">Fermer</button>
      </div>
    </div>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<!-- Modale √©dition admin -->
<div class="editMask" id="editMask" aria-hidden="true">
  <div class="editBox" role="dialog" aria-label="Modifier le dossier">
    <div class="editBar">
      <h2 id="editTitle">Modifier le dossier</h2>
      <div style="display:flex;gap:8px;">
        <button class="btnEditCancel" id="editCancel">Annuler</button>
        <button class="btnEditSave" id="editSave">üíæ Enregistrer</button>
      </div>
    </div>
    <div class="editContent" id="editContent"></div>
    <div class="editFooter">
      <button class="btnEditCancel" id="editCancel2">Annuler</button>
      <button class="btnEditSave" id="editSave2">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<script>
let LIMITED_VIEW = false;
let VIEW_MODE    = "ALL";
let IS_ADMIN     = false;

const API_BASE =
  (location.hostname.includes("wixsite.com") || location.hostname.endsWith(".wix.com"))
    ? ""
    : location.origin.replace(/\/$/, "");

function apiFetch(path, options = {}) {
  return fetch(`${API_BASE}${path}`, {
    credentials: "same-origin",
    cache: "no-store",
    ...options
  });
}

const $tbody = document.querySelector("#tab tbody");
const $filter = document.getElementById("filterMag");
const $filterService = document.getElementById("filterService");
const $serviceFilterContainer = document.getElementById("serviceFilterContainer");
const $q      = document.getElementById("q");
const $mask   = document.getElementById("mask");
const $btnClose = document.getElementById("btnClose");
const $btnPrint = document.getElementById("btnPrint");
const $modalTitle = document.getElementById("modalTitle");
const $modalContent = document.getElementById("modalContent");
const $legend = document.getElementById("legend");
const $statusTabs = document.getElementById("statusTabs");

let IS_LOADING = true;

function setTableLoading(msg){
  $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#334155">
    <span class="spinner" aria-hidden="true" style="margin-right:8px"></span>${msg||"Chargement‚Ä¶"}
  </td></tr>`;
}

function showLoginOverlay(message = "Session expir√©e. Merci de vous reconnecter.") {
  const overlay = document.getElementById("loginOverlay");
  const errBox = document.getElementById("loginError");
  if (overlay) overlay.style.display = "flex";
  if (errBox) errBox.textContent = message;
}

const LABELS = ["Demande envoy√©","Pi√®ce re√ßu","Travaux en cours","Renvoy√©"];

function getStatusLabelsForService(service) {
  const s = (service || "").trim();
  if (s === "Arbre de Transmission") {
    return [
      "Demande envoy√©",
      "Pi√®ce envoy√© chez Fournisseurs",
      "Pi√®ce renvoy√© √† l'agence"
    ];
  }
  return LABELS;
}

function displayStatusLabel(status){
  if (status === "Renvoy√©") return "Pi√®ce Renvoy√©";
  return status;
}

function badge(status){
  const map = {
    "Demande envoy√©": "s-1",
    "Pi√®ce re√ßu": "s-2",
    "Travaux en cours": "s-3",
    "Renvoy√©": "s-4",
    "Pi√®ce envoy√© chez Fournisseurs": "s-2",
    "Pi√®ce renvoy√© √† l'agence": "s-4"
  };
  const cls = map[status] || "s-1";
  return `<span class="badge ${cls}">${displayStatusLabel(status)}</span>`;
}

function p2(n){ return String(n).padStart(2,"0"); }
function parseDate(v){
  if (!v && v!==0) return null;
  const d = new Date(v);
  if (!isNaN(d)) return d;
  const m1 = String(v).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m1) { const d2 = new Date(+m1[1], +m1[2]-1, +m1[3]); return isNaN(d2)?null:d2; }
  const m2 = String(v).match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (m2) { const d2 = new Date(+m2[3], +m2[2]-1, +m2[1]); return isNaN(d2)?null:d2; }
  return null;
}
function fmtJJMMYYYYdash(v){ const d = parseDate(v); return d ? `${p2(d.getDate())}-${p2(d.getMonth()+1)}-${d.getFullYear()}` : "‚Äî"; }

const MONTHS_FULL = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
let YEAR_FILTER = '';
let MONTH_FILTER = '';
let STATUS_FILTER = '';

function matchesServiceByView(row){
  const svc = (row.service || "").trim();
  if (VIEW_MODE === "STE") {
    return ["Rectification Culasse", "Contr√¥le injection Diesel", "Contr√¥le injection Essence"].includes(svc);
  }
  if (VIEW_MODE === "BG") {
    return svc === "Arbre de Transmission";
  }
  if (VIEW_MODE === "CHASSE") {
    return ["Rectification des Volants Moteur", "Regarnissages Machoires"].includes(svc);
  }
  if (VIEW_MODE === "ADMIN") {
    return ["Rectification Culasse", "Contr√¥le injection Diesel", "Contr√¥le injection Essence", "Rectification des Volants Moteur", "Regarnissages Machoires", "Arbre de Transmission"].includes(svc);
  }
  return true;
}

function buildMonths(year){
  const ctn = document.getElementById(`months-${year}`); if(!ctn) return;
  ctn.innerHTML = '';
  MONTHS_FULL.forEach((label, idx)=>{
    const m = idx+1;
    const btn = document.createElement('button');
    btn.type = 'button'; btn.className = 'monthBtn';
    btn.dataset.month = String(m); btn.dataset.year = String(year);
    btn.textContent = label; ctn.appendChild(btn);
  });
  const allBtn = document.createElement('button');
  allBtn.type = 'button'; allBtn.className = 'monthBtn';
  allBtn.dataset.month = 'all'; allBtn.dataset.year = String(year);
  allBtn.textContent = 'Tout'; ctn.appendChild(allBtn);
}
function setYearActive(year){
  YEAR_FILTER = String(year||'') || ''; MONTH_FILTER = '';
  document.querySelectorAll('.yearBtn').forEach(b=>{
    const on = String(b.dataset.year)===String(year);
    b.classList.toggle('active', on);
    b.setAttribute('aria-selected', on?'true':'false');
  });
  document.querySelectorAll('.months').forEach(div=>{
    div.classList.toggle('active', div.id===`months-${year}`);
  });
  document.querySelectorAll(`#months-${year} .monthBtn`).forEach(b=> b.classList.remove('active'));
  draw();
}
function setMonthActive(year, month){
  if(String(YEAR_FILTER)!==String(year)) setYearActive(year);
  MONTH_FILTER = String(month||'');
  document.querySelectorAll(`#months-${year} .monthBtn`).forEach(b=>{
    b.classList.toggle('active', String(b.dataset.month)===String(month));
  });
  draw();
}
document.querySelector('.yearTabs').addEventListener('click', (e)=>{
  const b = e.target.closest('.yearBtn'); if(!b) return; setYearActive(b.dataset.year);
});
document.getElementById('months-2025').addEventListener('click', (e)=>{
  const b = e.target.closest('.monthBtn'); if(!b) return; setMonthActive('2025', b.dataset.month);
});
document.getElementById('months-2026').addEventListener('click', (e)=>{
  const b = e.target.closest('.monthBtn'); if(!b) return; setMonthActive('2026', b.dataset.month);
});

$statusTabs.addEventListener("click", (e)=>{
  const btn = e.target.closest(".statusBtn");
  if (!btn) return;
  STATUS_FILTER = btn.dataset.status || "";
  document.querySelectorAll(".statusBtn").forEach(b=>{
    b.classList.toggle("active", b === btn);
  });
  draw();
});

let rows = [];
let POLL_TIMER = null;
let POLL_IN_FLIGHT = false;
let LAST_MAX_NO = 0;

function getMaxNo(list){
  return list.reduce((m, r) => {
    const n = parseInt(String(r.no).replace(/\D/g, ''), 10) || 0;
    return Math.max(m, n);
  }, 0);
}

async function fetchCasesNormalized(){
  const r = await apiFetch("/atelier/api/cases");
  if (r.status === 401) throw new Error("AUTH_REQUIRED");
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const json = await r.json();
  const data = (json && json.data) || [];

  return data.map(x=>{
    const h = (x.snapshot && x.snapshot.header) || {};
    return {
      ...x,
      magasin: x.magasin || (h && h.magasin) || "",
      compte:  x.compte  || (h && h.compte)  || "",
      client:  x.client  || (h && h.client)  || "",
      service: x.service || (h && h.service) || "",
      demandeDate: x.demandeDate || (h && h.dateDemande) || "",
      estimation: (x.estimation === undefined || x.estimation === null || x.estimation === "") ? "" : Number(x.estimation)
    };
  });
}

function startPolling(ms = 45000){
  stopPolling();
  POLL_TIMER = setInterval(async ()=>{
    if (document.hidden) return;
    if ($mask && $mask.style.display === "flex") return;
    if (POLL_IN_FLIGHT) return;

    POLL_IN_FLIGHT = true;
    try{
      const currentServiceSelected = ($filterService && $filterService.value) ? $filterService.value : "";
      const fresh = await fetchCasesNormalized();

      const newMax = getMaxNo(fresh);
      const hadNew = newMax > (LAST_MAX_NO || 0);

      rows = fresh;
      LAST_MAX_NO = newMax;

      if (LIMITED_VIEW) {
        if ($serviceFilterContainer) $serviceFilterContainer.style.display = "inline-block";
        buildServiceFilterOptions();
        if ($filterService && currentServiceSelected) {
          $filterService.value = currentServiceSelected;
        }
      }

      draw();

      if (hadNew && $legend){
        const old = $legend.textContent;
        $legend.textContent = `${old} ‚Ä¢ ‚úÖ Nouveau dossier`;
        setTimeout(()=>{ if($legend) $legend.textContent = old; }, 3500);
      }
    } catch(e){
      if (String(e?.message || "").includes("AUTH_REQUIRED")) {
        stopPolling();
        showLoginOverlay();
      } else {
        console.warn("[SUIVI] Polling error:", e);
      }
    } finally {
      POLL_IN_FLIGHT = false;
    }
  }, ms);
}

function stopPolling(){
  if (POLL_TIMER) clearInterval(POLL_TIMER);
  POLL_TIMER = null;
}

function buildEstimateSelect(value){
  const v = (value === "" || value === null || value === undefined) ? "" : Number(value);
  let opts = `<option value="" ${v==="" ? "selected":""}></option>`;
  for (let i=1;i<=10;i++){
    opts += `<option value="${i}" ${v===i ? "selected":""}>${i}</option>`;
  }
  return `<select class="etaSel" aria-label="Estimation Temps Travaux">${opts}</select>`;
}

function matchesYearMonth(d){
  if (!YEAR_FILTER) return true;
  if (!d) return false;
  if (String(d.getFullYear()) !== String(YEAR_FILTER)) return false;
  if (!MONTH_FILTER || MONTH_FILTER==='all') return true;
  return (d.getMonth()+1) === Number(MONTH_FILTER);
}

function buildServiceFilterOptions() {
  if (!$filterService) return;

  const services = new Set();
  rows.forEach(r => {
    const svc = (r.service || "").trim();
    if (svc) services.add(svc);
  });

  const current = $filterService.value;
  let html = '<option value="">Tous</option>';
  Array.from(services).sort().forEach(s => {
    const selected = (s === current) ? ' selected' : '';
    html += `<option value="${s}"${selected}>${s}</option>`;
  });
  $filterService.innerHTML = html;
}

function applyLimitedView(){
  if (!LIMITED_VIEW) return;

  const thActions = document.querySelector("th.th-actions");
  if (thActions) thActions.style.display = "none";
  document.querySelectorAll("td.col-actions").forEach(td => { td.style.display = "none"; });
  document.querySelectorAll("col.col-actions").forEach(col => { col.style.display = "none"; });

  document.querySelectorAll("select.etaSel").forEach(sel => {
    sel.classList.add("readonlyLimited");
    sel.setAttribute("tabindex","-1");
  });
}

function draw(){
  if (IS_LOADING) { setTableLoading("Chargement des dossiers‚Ä¶"); return; }

  const mag = $filter.value.trim().toLowerCase();
  const q = $q.value.trim().toLowerCase();
  const serviceFilterValue =
    (LIMITED_VIEW && $filterService)
      ? $filterService.value.trim()
      : "";

  const list = [...rows].sort((a, b) => {
    const na = parseInt(String(a.no).replace(/\D/g, ''), 10) || 0;
    const nb = parseInt(String(b.no).replace(/\D/g, ''), 10) || 0;
    return nb - na;
  });

  let count = 0;
  $tbody.innerHTML = "";
  list
    .filter(r => !mag || (r.magasin||"").toLowerCase() === mag)
    .filter(r => matchesYearMonth(parseDate(r.demandeDate)))
    .filter(r => matchesServiceByView(r))
    .filter(r => {
      if (!serviceFilterValue) return true;
      return (r.service || "").trim() === serviceFilterValue;
    })
    .filter(r => {
      if (!q) return true;
      const noStr   = String(r.no).padStart(5,'0');
      const compte  = (r.compte || "").toLowerCase();
      const client  = (r.client || "").toLowerCase();
      const isNum   = /^\d+$/.test(q);
      if (isNum) return noStr.includes(q);
      return compte.includes(q) || client.includes(q);
    })
    .filter(r => {
      if (!STATUS_FILTER) return true;
      return (r.status || "") === STATUS_FILTER;
    })
    .forEach(r => {
      count++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-no nowrap"        title="${String(r.no)}">${String(r.no).padStart(5,'0')}</td>
        <td class="col-magasin wrap-ok"  title="${r.magasin||""}">${r.magasin||""}</td>
        <td class="col-compte truncate"  title="${r.compte||""}">${r.compte||""}</td>
        <td class="col-client truncate"  title="${r.client||""}">${r.client||""}</td>
        <td class="col-service truncate" title="${r.service||""}">${r.service||""}</td>
        <td class="col-date nowrap"      title="${fmtJJMMYYYYdash(r.demandeDate)}">${fmtJJMMYYYYdash(r.demandeDate)}</td>
        <td class="col-statut nowrap">${badge(r.status)}</td>
        <td class="col-eta nowrap">
          <div class="etaGroup">
            ${buildEstimateSelect(r.estimation)}
            <button class="btnView">Voir<br>dossier</button>
          </div>
        </td>
        <td class="col-actions nowrap">
          <div class="actions">
            <select class="statusSel">
              ${getStatusLabelsForService(r.service).map(lbl => `
                <option value="${lbl}" ${r.status === lbl ? "selected" : ""}>
                  ${displayStatusLabel(lbl)}
                </option>
              `).join("")}
            </select>
            <button class="btnSave">Valider</button>
            ${IS_ADMIN ? `<button class="btnEdit">‚úèÔ∏è</button>` : ""}
            ${IS_ADMIN ? `<button class="btnDelete">üóëÔ∏è</button>` : ""}
          </div>
        </td>
      `;

      tr.querySelector(".btnView").addEventListener("click", ()=> openDetails(r));

      if (IS_ADMIN) {
        const editBtn = tr.querySelector(".btnEdit");
        if (editBtn) editBtn.addEventListener("click", () => openEditModal(r));
        const deleteBtn = tr.querySelector(".btnDelete");
        if (deleteBtn) deleteBtn.addEventListener("click", () => deleteDossier(r, tr));
      }

      tr.querySelector(".btnSave").addEventListener("click", async ()=>{
        if (LIMITED_VIEW) return;
        const statusSel = tr.querySelector(".statusSel");
        const etaSel = tr.querySelector(".etaSel");
        const saveBtn = tr.querySelector(".btnSave");
        const oldHtml = saveBtn.innerHTML;
        const status = statusSel.value;
        const estimation = etaSel.value ? Number(etaSel.value) : "";

        try{
          saveBtn.disabled = true; statusSel.disabled = true; etaSel.disabled = true;
          saveBtn.innerHTML = `<span class="spinner" aria-hidden="true"></span>`;

          const resp = await apiFetch(`/atelier/api/cases/${encodeURIComponent(r.no)}/status`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ status, estimation })
          });
          if(!resp.ok){
            if (resp.status === 401) {
              stopPolling();
              showLoginOverlay();
              return;
            }
            alert(`Erreur de mise √† jour (${resp.status})`);
            return;
          }

          r.status = status;
          r.estimation = estimation;

          const badgeCell = tr.querySelector(".col-statut");
          if (badgeCell) badgeCell.innerHTML = badge(r.status);
        } finally{
          saveBtn.innerHTML = oldHtml;
          saveBtn.disabled = false; statusSel.disabled = false; etaSel.disabled = false;
        }
      });

      $tbody.appendChild(tr);
    });

  if (count === 0){
    $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#334155">Aucun dossier.</td></tr>`;
  }

  const ymText = YEAR_FILTER
    ? (MONTH_FILTER && MONTH_FILTER!=='all'
        ? `${MONTHS_FULL[Number(MONTH_FILTER)-1]} ${YEAR_FILTER}`
        : `Tout ${YEAR_FILTER}`)
    : 'Toutes ann√©es';

  const statusText = STATUS_FILTER
    ? ` ‚Ä¢ Statut : ${displayStatusLabel(STATUS_FILTER)}`
    : ' ‚Ä¢ Statut : Tous';

  $legend.textContent = `${count} dossier(s) ‚Ä¢ ${ymText}${statusText}`;

  if (LIMITED_VIEW) applyLimitedView();
}

function esc(s){ return String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

function openDetails(row){
  const h = (row.snapshot && row.snapshot.header) || {};
  const cul = (row.snapshot && row.snapshot.culasse) || null;
  const inj = (row.snapshot && row.snapshot.injecteur) || null;
  const com = (row.snapshot && row.snapshot.commentaires) ? String(row.snapshot.commentaires).trim() : "";

  let opsHTML = "";
  if (cul && Array.isArray(cul.operations) && cul.operations.length){
    opsHTML = cul.operations.map(op=>{
      const refs = Array.isArray(op.references) ? op.references.map(r=>{
        const bits = [];
        if (r.reference) bits.push(esc(r.reference));
        if (r.libelleRef) bits.push(esc(r.libelleRef));
        if (r.prixHT || r.prixHT===0) bits.push(`${esc(String(r.prixHT))} ‚Ç¨ HT`);
        return `<div class="sub">- ${bits.join(" ‚Äì ")}</div>`;
      }).join("") : "";
      return `<div class="bul">‚Ä¢ ${esc(op.libelle || op.ligne)}</div>${refs}`;
    }).join("");
  }

  const piecesHTML = (cul && Array.isArray(cul.piecesAFournir) && cul.piecesAFournir.length)
    ? cul.piecesAFournir.map(p=>`<div class="bul">‚Ä¢ ${esc(p)}</div>`).join("")
    : "<div class='bul' style='opacity:.7'>Aucune pi√®ce s√©lectionn√©e.</div>";

  $modalTitle.textContent = `Dossier ${String(row.no).padStart(5,'0')} ‚Äî ${h.service || ""}`;
  $modalContent.innerHTML = `
    <div class="grid2">
      <div><span class="label">N¬∞ dossier :</span> ${esc(String(row.no).padStart(5,'0'))}</div>
      <div><span class="label">Date :</span> ${fmtJJMMYYYYdash(row.demandeDate)}</div>
      <div><span class="label">Magasin :</span> ${esc(h.magasin||row.magasin||"")}</div>
      <div><span class="label">Statut :</span> ${esc(displayStatusLabel(row.status||""))}</div>
      <div><span class="label">Client :</span> ${esc(h.client||row.client||"")}</div>
      <div><span class="label">N¬∞ de compte :</span> ${esc(h.compte||row.compte||"")}</div>
      <div><span class="label">T√©l√©phone :</span> ${esc(h.telephone||"")}</div>
      <div><span class="label">Email :</span> ${esc(h.email||"")}</div>
      <div><span class="label">V√©hicule :</span> ${esc(h.vehicule||"")}</div>
      <div><span class="label">Immat. :</span> ${esc(h.immat||"")}</div>
      <div><span class="label">Service :</span> ${esc(h.service||row.service||"")}</div>
      <div><span class="label">Estimation :</span> ${esc(row.estimation || "‚Äî")}</div>
      <div><span class="label">Date demande :</span> ${esc(fmtJJMMYYYYdash(h.dateDemande||row.demandeDate))}</div>
    </div>

    ${h.service === "Rectification Culasse" && cul ? `
      <div class="section">
        <h3>D√©tails Rectification Culasse</h3>
        ${opsHTML || "<div class='bul' style='opacity:.7'>Aucune op√©ration coch√©e.</div>"}
        <div class="section">
          <h3>Pi√®ces √† fournir</h3>
          ${piecesHTML}
        </div>
      </div>
    ` : ""}

    ${(h.service === "Contr√¥le injection Diesel" || h.service === "Contr√¥le injection Essence") && inj ? `
      <div class="section">
        <h3>D√©tails Contr√¥le injection</h3>
        <div class="grid2">
          <div><span class="label">Type :</span> ${esc(inj.type||"")}</div>
          <div><span class="label">Nb injecteurs :</span> ${esc(inj.nombre||"")}</div>
        </div>
      </div>
    ` : ""}

    ${com ? `
      <div class="section">
        <h3>Commentaires</h3>
        <div class="area">${esc(com)}</div>
      </div>
    ` : ""}
  `;
  $mask.style.display = "flex";
  $mask.setAttribute("aria-hidden","false");
}

document.getElementById("btnClose").addEventListener("click", ()=>{
  $mask.style.display = "none";
  $mask.setAttribute("aria-hidden","true");
  $modalContent.innerHTML = "";
});

document.getElementById("btnPrint").addEventListener("click", () => {
  const w = window.open("", "_blank");
  if (!w) {
    alert("Veuillez autoriser les fen√™tres pop-up pour l‚Äôimpression.");
    return;
  }

  w.document.open();
  w.document.write(`
    <html>
      <head>
        <title>${$modalTitle.textContent}</title>
        <meta charset="utf-8" />
        <style>
          body{font-family:system-ui,Arial,sans-serif;padding:20px;color:#0f172a}
          h3{color:#004080;margin-top:16px}
          .label{font-weight:700}
          .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;margin-bottom:10px}
          .section{margin-top:14px}
          .bul{margin:6px 0}
          .sub{margin:2px 0 0 18px}
          .area{border:1px solid #ccc;padding:10px;white-space:pre-wrap}
        </style>
      </head>
      <body>
        ${$modalContent.innerHTML}
      </body>
    </html>
  `);
  w.document.close();

  w.addEventListener("load", () => {
    w.focus();
    w.print();
    w.addEventListener("afterprint", () => { w.close(); });
  });
});

function load(){
  IS_LOADING = true;
  setTableLoading("Chargement des dossiers‚Ä¶");

  buildMonths(2025);
  buildMonths(2026);

  const now = new Date();
  const y = now.getFullYear();

  if (y === 2025 || y === 2026) {
    setMonthActive(String(y), 'all');
  } else {
    YEAR_FILTER = '';
    MONTH_FILTER = '';
    draw();
  }

  (async ()=>{
    let authError = false;
    try{
      const fresh = await fetchCasesNormalized();
      rows = fresh;
      LAST_MAX_NO = getMaxNo(fresh);
    } catch(e){
      if (String(e?.message || "").includes("AUTH_REQUIRED")) {
        authError = true;
        showLoginOverlay();
      } else {
        console.error(e);
        $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#b91c1c">Erreur de chargement.</td></tr>`;
      }
    } finally {
      IS_LOADING = false;

      if (LIMITED_VIEW) {
        if ($serviceFilterContainer) $serviceFilterContainer.style.display = "inline-block";
        buildServiceFilterOptions();
      } else {
        if ($serviceFilterContainer) $serviceFilterContainer.style.display = "none";
      }

      draw();

      if (!authError) {
        startPolling(45000);
        window.addEventListener("beforeunload", stopPolling);
      }
    }
  })();
}

// ‚îÄ‚îÄ‚îÄ ADMIN : Modifier / Supprimer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _editRow = null;

function openEditModal(row) {
  _editRow = row;
  const h = (row.snapshot && row.snapshot.header) || {};
  const cul = (row.snapshot && row.snapshot.culasse) || {};
  const inj = (row.snapshot && row.snapshot.injecteur) || {};
  const com = (row.snapshot && row.snapshot.commentaires) || "";
  const svc = h.service || row.service || "";

  document.getElementById("editTitle").textContent =
    `Modifier dossier ${String(row.no).padStart(5,"0")} ‚Äî ${svc}`;

  const etaOpts = ["","1","2","3","4","5","6","7","8","9","10"]
    .map(v => `<option value="${v}" ${String(row.estimation ?? "") === v ? "selected" : ""}>${v || "‚Äî"}</option>`)
    .join("");

  const statusOpts = getStatusLabelsForService(row.service)
    .map(lbl => `<option value="${lbl}" ${row.status === lbl ? "selected" : ""}>${displayStatusLabel(lbl)}</option>`)
    .join("");

  document.getElementById("editContent").innerHTML = `
    <div class="editSection">
      <h3>Statut &amp; Estimation</h3>
      <div class="editGrid">
        <div class="editField"><label>Statut</label><select id="ef_status">${statusOpts}</select></div>
        <div class="editField"><label>Estimation Temps Travaux (Jours)</label><select id="ef_estimation">${etaOpts}</select></div>
      </div>
    </div>
    <div class="editSection">
      <h3>Informations client</h3>
      <div class="editGrid">
        <div class="editField"><label>Magasin</label><input id="ef_magasin" value="${esc(h.magasin||row.magasin||"")}"></div>
        <div class="editField"><label>Client</label><input id="ef_client" value="${esc(h.client||row.client||"")}"></div>
        <div class="editField"><label>N¬∞ de compte</label><input id="ef_compte" value="${esc(h.compte||row.compte||"")}"></div>
        <div class="editField"><label>T√©l√©phone</label><input id="ef_telephone" value="${esc(h.telephone||"")}"></div>
        <div class="editField"><label>Email</label><input id="ef_email" value="${esc(h.email||"")}"></div>
        <div class="editField"><label>V√©hicule</label><input id="ef_vehicule" value="${esc(h.vehicule||"")}"></div>
        <div class="editField"><label>Immatriculation</label><input id="ef_immat" value="${esc(h.immat||"")}"></div>
        <div class="editField"><label>Date de demande</label><input id="ef_dateDemande" value="${esc(h.dateDemande||row.demandeDate||"")}"></div>
      </div>
    </div>
    ${svc === "Rectification Culasse" ? `
    <div class="editSection">
      <h3>D√©tails Culasse</h3>
      <div class="editGrid">
        <div class="editField"><label>Segment (VL/PL)</label><input id="ef_segment" value="${esc(cul.segment||"")}"></div>
        <div class="editField"><label>Cylindre</label><input id="ef_cylindre" value="${esc(cul.cylindre||"")}"></div>
        <div class="editField"><label>Soupapes</label><input id="ef_soupapes" value="${esc(cul.soupapes||"")}"></div>
        <div class="editField"><label>Carburant</label><input id="ef_carburant" value="${esc(cul.carburant||"")}"></div>
      </div>
    </div>` : ""}
    ${(svc === "Contr√¥le injection Diesel" || svc === "Contr√¥le injection Essence") ? `
    <div class="editSection">
      <h3>D√©tails Injection</h3>
      <div class="editGrid">
        <div class="editField"><label>Type</label><input id="ef_injType" value="${esc(inj.type||"")}"></div>
        <div class="editField"><label>Nombre d'injecteurs</label><input id="ef_injNombre" value="${esc(inj.nombre||"")}"></div>
      </div>
    </div>` : ""}
    <div class="editSection">
      <h3>Commentaires</h3>
      <div class="editField"><textarea id="ef_commentaires">${esc(com)}</textarea></div>
    </div>
  `;

  const editMask = document.getElementById("editMask");
  editMask.style.display = "flex";
  editMask.setAttribute("aria-hidden","false");
}

function closeEditModal() {
  const editMask = document.getElementById("editMask");
  editMask.style.display = "none";
  editMask.setAttribute("aria-hidden","true");
  document.getElementById("editContent").innerHTML = "";
  _editRow = null;
}

async function saveEditModal() {
  if (!_editRow) return;
  const row = _editRow;
  const get = (id) => { const el = document.getElementById(id); return el ? el.value : null; };

  const status = get("ef_status") || row.status;
  const estVal = get("ef_estimation");
  const estimation = estVal !== null ? (estVal ? Number(estVal) : "") : row.estimation;

  const newSnapshot = JSON.parse(JSON.stringify(row.snapshot || {}));
  if (!newSnapshot.header) newSnapshot.header = {};

  ["magasin","client","compte","telephone","email","vehicule","immat","dateDemande"].forEach(f => {
    const v = get(`ef_${f}`); if (v !== null) newSnapshot.header[f] = v;
  });

  const com = get("ef_commentaires");
  if (com !== null) newSnapshot.commentaires = com;

  const svc = newSnapshot.header.service || row.service || "";
  if (svc === "Rectification Culasse") {
    if (!newSnapshot.culasse) newSnapshot.culasse = {};
    ["segment","cylindre","soupapes","carburant"].forEach(f => {
      const v = get(`ef_${f}`); if (v !== null) newSnapshot.culasse[f] = v;
    });
  }
  if (svc.startsWith("Contr√¥le injection")) {
    if (!newSnapshot.injecteur) newSnapshot.injecteur = {};
    const t = get("ef_injType"); if (t !== null) newSnapshot.injecteur.type = t;
    const n = get("ef_injNombre"); if (n !== null) newSnapshot.injecteur.nombre = n;
  }

  const updates = {
    status, estimation,
    magasin: newSnapshot.header.magasin || row.magasin,
    compte:  newSnapshot.header.compte  || row.compte,
    client:  newSnapshot.header.client  || row.client,
    demandeDate: newSnapshot.header.dateDemande || row.demandeDate,
    snapshot: newSnapshot
  };

  const s1 = document.getElementById("editSave");
  const s2 = document.getElementById("editSave2");
  try {
    [s1,s2].forEach(b => { if(b){ b.disabled=true; b.textContent="Enregistrement‚Ä¶"; } });
    const resp = await apiFetch(`/atelier/api/cases/${encodeURIComponent(row.no)}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updates)
    });
    if (!resp.ok) { alert(`Erreur lors de la sauvegarde (${resp.status})`); return; }
    const data = await resp.json();
    Object.assign(row, updates);
    if (data.data) Object.assign(row, data.data);
    closeEditModal();
    draw();
  } catch(e) {
    alert("Erreur r√©seau : " + e.message);
  } finally {
    [s1,s2].forEach(b => { if(b){ b.disabled=false; b.textContent="üíæ Enregistrer"; } });
  }
}

async function deleteDossier(row, tr) {
  const label = `Dossier ${String(row.no).padStart(5,"0")} ‚Äî ${row.client||""} (${row.magasin||""})`;
  if (!confirm(`‚ö†Ô∏è Supprimer d√©finitivement ce dossier ?\n\n${label}\n\nCette action est irr√©versible.`)) return;
  try {
    const resp = await apiFetch(`/atelier/api/cases/${encodeURIComponent(row.no)}`, { method: "DELETE" });
    if (!resp.ok) { alert(`Erreur lors de la suppression (${resp.status})`); return; }
    const idx = rows.findIndex(r => String(r.no) === String(row.no));
    if (idx !== -1) rows.splice(idx, 1);
    tr.remove();
    if ($tbody.querySelectorAll("tr").length === 0) {
      $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#334155">Aucun dossier.</td></tr>`;
    }
  } catch(e) {
    alert("Erreur r√©seau : " + e.message);
  }
}

document.getElementById("editCancel").addEventListener("click", closeEditModal);
document.getElementById("editCancel2").addEventListener("click", closeEditModal);
document.getElementById("editSave").addEventListener("click", saveEditModal);
document.getElementById("editSave2").addEventListener("click", saveEditModal);
document.getElementById("editMask").addEventListener("click", (e) => {
  if (e.target === e.currentTarget) closeEditModal();
});
// ‚îÄ‚îÄ‚îÄ fin ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

$filter.addEventListener("change", draw);
$q.addEventListener("input", draw);
if ($filterService) $filterService.addEventListener("change", draw);

(function initLogin(){
  const overlay = document.getElementById("loginOverlay");
  const input   = document.getElementById("loginPassword");
  const btn     = document.getElementById("loginBtn");
  const errBox  = document.getElementById("loginError");
  const remember = document.getElementById("rememberPwd");

  const LS_KEY = "dsg_suivi_pwd";

  // Restaurer la checkbox + mot de passe (si stock√©)
  try {
    const saved = localStorage.getItem(LS_KEY) || "";
    if (remember) remember.checked = !!saved;
    if (saved && input) input.value = saved;
  } catch {}

  function applySession(payload){
    LIMITED_VIEW = Boolean(payload?.isLimited);
    VIEW_MODE = String(payload?.viewMode || payload?.role || "ALL").toUpperCase();
    if (!VIEW_MODE) VIEW_MODE = "ALL";
    IS_ADMIN = Boolean(payload?.isAdmin);
  }

  function startApp(){
    if (errBox) errBox.textContent = "";
    if (overlay) overlay.style.display = "none";
    if (IS_ADMIN) {
      const h1 = document.querySelector("h1");
      if (h1 && !h1.querySelector(".adminBadge")) {
        h1.insertAdjacentHTML("beforeend", '<span class="adminBadge">‚öôÔ∏è Admin</span>');
      }
    }
    load();
  }

  async function restoreSession(){
    try {
      const resp = await apiFetch("/suivi-dossier/api/session");
      if (!resp.ok) return false;
      const payload = await resp.json().catch(() => ({}));
      if (!payload || !payload.success) return false;
      applySession(payload);
      return true;
    } catch {
      return false;
    }
  }

  async function handleLogin(){
    const v = (input?.value || "").trim();
    if (!v) {
      if (errBox) errBox.textContent = "Mot de passe requis.";
      if (input) input.focus();
      return;
    }

    if (errBox) errBox.textContent = "";
    if (btn) btn.disabled = true;

    try {
      const resp = await apiFetch("/suivi-dossier/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: v })
      });
      const payload = await resp.json().catch(() => ({}));
      if (!resp.ok || !payload?.success) {
        if (errBox) errBox.textContent = payload?.message || `Erreur (${resp.status})`;
        return;
      }

      applySession(payload);

      // Sauvegarder / supprimer le mot de passe selon la case √† cocher
      try {
        if (remember && remember.checked) localStorage.setItem(LS_KEY, v);
        else localStorage.removeItem(LS_KEY);
      } catch {}

      // on vide le champ (optionnel) pour √©viter d'afficher le mdp en clair apr√®s login
      if (input) input.value = "";

      startApp();
    } catch {
      if (errBox) errBox.textContent = "Erreur r√©seau.";
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  if (btn) btn.addEventListener("click", handleLogin);
  if (input) input.addEventListener("keydown", (e)=>{ if (e.key === "Enter") handleLogin(); });

  (async () => {
    const ok = await restoreSession();
    if (ok) {
      startApp();
    } else if (overlay) {
      overlay.style.display = "flex";
    }
  })();
})();
</script>
</body>
</html>
